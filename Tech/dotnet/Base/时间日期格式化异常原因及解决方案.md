# 时间日期格式化异常原因及解决方案

- Prepared by：ZhenLi

## 一、事件简介

- **事件时间**：2023-10-18 10:49

- **事件单号**：XXJS003-2023-007352

- **事件描述**：产线反馈 TBIE 打印下次 PM（预防维护）的时间条码时，条码格式不一致，部分条码使用 “/” 作为分隔符，部分使用 “-” 作为分隔符。

## 二、事件原因

1. **代码逻辑基础**：针对时间格式需求，代码内部已编写时间格式化相关逻辑。

1. **异常核心原因**：

- - 实际产线中，不同电脑打印时间条码时出现差异化结果；

- - 代码预设格式化目标为 “MM/dd-yy”，但实际输出却同时出现 “MM-dd-yy” 和 “MM/dd-yy” 两种格式；

- - 经后续测试验证确认：通过代码格式化后的时间字符串，不仅取决于代码中的格式设定，还与程序运行所在主机的系统环境相关。

## 三、时间格式化与运行环境的联系

### 1. 基本现象

- 格式化后的时间字符串，与本机电脑设置的系统时间格式强相关；

- 大多数服务器（通常为英文环境）不会出现此类格式化异常。

### 2. 验证测试

针对不同CultureInfo环境（中文、英文）、不同电脑系统时间格式设定，开展对比测试，结果如下表：

| 系统时间格式 | 代码格式化规则 | 格式化后 - 中文环境 | 格式化后 - 英文环境 |
| ------------ | -------------- | ------------------- | ------------------- |
| yyyy/MM/dd   | yyyy/MM/dd     | yyyy/MM/dd          | yyyy/MM/dd          |
| yyyy/MM/dd   | yyyy-MM-dd     | yyyy-MM-dd          | yyyy-MM-dd          |
| yyyy/MM/dd   | yyyy.MM.dd     | yyyy.MM.dd          | yyyy.MM.dd          |
| yyyy-MM-dd   | yyyy/MM/dd     | yyyy-MM-dd          | yyyy/MM/dd          |
| yyyy-MM-dd   | yyyy-MM-dd     | yyyy-MM-dd          | yyyy-MM-dd          |
| yyyy-MM-dd   | yyyy.MM.dd     | yyyy.MM.dd          | yyyy.MM.dd          |
| yyyy.MM.dd   | yyyy/MM/dd     | yyyy.MM.dd          | yyyy/MM/dd          |
| yyyy.MM.dd   | yyyy-MM-dd     | yyyy-MM-dd          | yyyy-MM-dd          |
| yyyy.MM.dd   | yyyy.MM.dd     | yyyy.MM.dd          | yyyy.MM.dd          |

### 3. 基本结论

使用DateTime.ToString()方法格式化时间字符串时，最终结果由两部分决定：

- 代码中给定的格式参数（如 “yyyy/MM/dd”）；

- 程序运行所在环境的文化设置（CultureInfo）。

**官方方法说明引用**：

DateTime的ToString()方法摘要明确指出：“将当前的DateTime对象的值转换为其等效的字符串表示形式，使用指定的格式和当前文化环境的格式约定。”

- **参数**：format为标准或自定义的日期时间格式字符串；

- **返回结果**：按format指定格式表示的DateTime对象字符串；

- **异常**：

1. 1. FormatException：若format长度为 1 且非System.Globalization.DateTimeFormatInfo定义的格式说明符，或format不含有效的自定义格式模式；

1. 1. ArgumentOutOfRangeException：日期时间超出当前文化所用日历支持的日期范围。

## 四、正确写法推荐

从 “限制格式生效范围” 和 “控制文化环境” 两个维度，提供三种解决方案，其中**方案三为推荐写法**：

### 方案 1：用单引号限定分隔符

通过单引号将时间格式中的分隔符（如 “/”“-”）标记为普通字符，避免其被系统文化环境篡改。

**示例代码**：

```
string sDate1 = DateTime.Now.ToString("yyyy'/'MM'/'dd");
```

### 方案 2：指定当前进程的文化环境

强制设置当前线程的文化环境，统一格式规则，但可能影响其他依赖文化环境的功能，存在未知风险。

**示例代码**：

```
Thread.CurrentThread.CurrentCulture = new CultureInfo("en-US");
```

### 方案 3：忽略当前文化格式（推荐）

通过System.Globalization.DateTimeFormatInfo.InvariantInfo参数，强制以代码指定的格式为准，与系统文化环境无关，确保格式一致性。

**示例代码**：

```
string sDate0 = DateTime.Now.ToString("yyyy-MM-dd", System.Globalization.DateTimeFormatInfo.InvariantInfo);
```

## 五、更多资料

1. 知乎：[就是这么坑：DateTime 的字符串格式](https://zhihu.com)

1. Microsoft Learn：[自定义日期和时间格式字符串 - .NET](https://learn.microsoft.com/zh-cn/dotnet/standard/base-types/custom-date-and-time-format-strings)

1. Microsoft Learn：[DateTimeFormatInfo.DateSeparator 属性（System.Globalization）](https://learn.microsoft.com/zh-cn/dotnet/api/system.globalization.datetimeformatinfo.dateseparator?view=net-7.0)

1. Microsoft Learn：[DateTimeFormatInfo.InvariantInfo Property (System.Globalization)](https://learn.microsoft.com/zh-cn/dotnet/api/system.globalization.datetimeformatinfo.invariantinfo?view=net-7.0)